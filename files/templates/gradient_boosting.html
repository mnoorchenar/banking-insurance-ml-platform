{% extends 'base.html' %}
{% block title %}Gradient Boosting{% endblock %}
{% block breadcrumb %}<li class="breadcrumb-item active">Gradient Boosting</li>{% endblock %}

{% block content %}
<div class="page-header">
  <div class="d-flex align-items-start justify-content-between flex-wrap gap-2">
    <div>
      <h2 class="page-title"><i class="bi bi-lightning-charge-fill me-2"></i>Gradient Boosting <span class="badge bg-orange fs-6 ms-1">Boosting</span></h2>
      <p class="page-subtitle">Sequential ensemble: each new tree corrects the errors of all previous trees by fitting residuals. Often achieves the highest accuracy.</p>
    </div>
    <div class="view-switch">
      <button class="btn btn-sm btn-primary active" id="btn-ds-view" onclick="switchView('ds')"><i class="bi bi-cpu me-1"></i>Data Scientist</button>
      <button class="btn btn-sm btn-outline-success" id="btn-biz-view" onclick="switchView('biz')"><i class="bi bi-people me-1"></i>Stakeholder</button>
    </div>
  </div>
</div>

<div class="control-panel mb-4">
  <div class="row g-3 align-items-end">
    <div class="col-sm-4 col-lg-2">
      <label class="form-label">N Estimators</label>
      <input type="range" class="form-range" id="gb-n" min="20" max="400" step="10" value="100"
             oninput="document.getElementById('gb-n-val').textContent=this.value">
      <div class="d-flex justify-content-between"><small>20</small><small id="gb-n-val" class="fw-bold">100</small><small>400</small></div>
    </div>
    <div class="col-sm-4 col-lg-2">
      <label class="form-label">Learning Rate</label>
      <select class="form-select form-select-sm" id="gb-lr">
        <option value="0.01">0.01 (slow)</option><option value="0.05">0.05</option>
        <option value="0.10" selected>0.10 (default)</option><option value="0.20">0.20</option>
        <option value="0.50">0.50 (fast)</option>
      </select>
    </div>
    <div class="col-sm-4 col-lg-2">
      <label class="form-label">Max Depth</label>
      <select class="form-select form-select-sm" id="gb-depth">
        <option value="2">2</option><option value="3" selected>3 (default)</option>
        <option value="4">4</option><option value="5">5</option><option value="7">7</option>
      </select>
    </div>
    <div class="col-sm-4 col-lg-2">
      <label class="form-label">Subsample</label>
      <select class="form-select form-select-sm" id="gb-sub">
        <option value="0.5">0.5</option><option value="0.7">0.7</option>
        <option value="0.8" selected>0.8 (default)</option><option value="1.0">1.0 (no subsample)</option>
      </select>
    </div>
    <div class="col-auto">
      <button class="btn btn-warning text-dark" onclick="runGB()"><i class="bi bi-play-fill me-1"></i>Train Model</button>
    </div>
    <div class="col-auto" id="gb-spinner" style="display:none">
      <div class="spinner-border spinner-border-sm text-warning"></div>
    </div>
  </div>
</div>

<div class="row g-3 mb-4" id="gb-metrics"></div>

<div id="view-ds">
  <div class="row g-4">
    <div class="col-lg-6"><div class="chart-card"><div id="gb-staged" style="height:380px"></div></div></div>
    <div class="col-lg-6"><div class="chart-card"><div id="gb-roc" style="height:380px"></div></div></div>
    <div class="col-lg-6"><div class="chart-card"><div id="gb-importance" style="height:380px"></div></div></div>
    <div class="col-lg-6"><div class="chart-card"><div id="gb-cm" style="height:380px"></div></div></div>
  </div>
  <div class="insight-box mt-3">
    <i class="bi bi-lightbulb-fill me-2 text-warning"></i>
    <strong>Boosting vs Bagging:</strong>
    Bagging (Random Forest) reduces <em>variance</em> by averaging parallel trees.
    Boosting reduces <em>bias</em> by sequentially correcting errors.
    Watch the staged-score curve ‚Äî if test score peaks and then falls, you have overfitting; reduce learning_rate or n_estimators.
    <strong>Subsample &lt; 1.0</strong> (Stochastic GBM) adds randomness and often helps generalization.
  </div>
</div>

<div id="view-biz" style="display:none">
  <div class="stakeholder-banner mb-4">
    <i class="bi bi-info-circle-fill me-2"></i>
    <strong>What is Gradient Boosting?</strong>
    Imagine a team of analysts where each new analyst focuses specifically on cases the previous ones got wrong.
    Over many rounds, the team becomes highly accurate. This is the most powerful model in our suite ‚Äî but also the least transparent.
  </div>
  <div class="row g-4">
    <div class="col-lg-8"><div class="chart-card"><div id="gb-biz-feat" style="height:380px"></div></div></div>
    <div class="col-lg-4">
      <div class="chart-card">
        <h6 class="fw-bold mb-3">üìã Model Report Card</h6>
        <div id="gb-biz-report"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let gbResult = null;
function onDatasetChange() { runGB(); }
function switchView(v) {
  document.getElementById('view-ds').style.display  = v==='ds'  ? '' : 'none';
  document.getElementById('view-biz').style.display = v==='biz' ? '' : 'none';
  document.getElementById('btn-ds-view').className  = 'btn btn-sm ' + (v==='ds'  ? 'btn-primary active' : 'btn-outline-primary');
  document.getElementById('btn-biz-view').className = 'btn btn-sm ' + (v==='biz' ? 'btn-success active' : 'btn-outline-success');
  if (v==='biz' && gbResult) renderBiz(gbResult);
}

async function runGB() {
  show('gb-spinner');
  gbResult = await apiPost('/api/model/gradient-boosting', {
    dataset: CURRENT_DATASET,
    n_estimators: parseInt(document.getElementById('gb-n').value),
    learning_rate: parseFloat(document.getElementById('gb-lr').value),
    max_depth: parseInt(document.getElementById('gb-depth').value),
    subsample: parseFloat(document.getElementById('gb-sub').value),
  });
  hide('gb-spinner');
  renderMetrics('gb-metrics', gbResult.metrics, gbResult.train_size, gbResult.test_size);
  renderGBCharts(gbResult);
}

function renderGBCharts(r) {
  const ss = r.staged_scores;
  const peakI = ss.test.indexOf(Math.max(...ss.test));
  Plotly.newPlot('gb-staged', [
    { x: ss.stages, y: ss.train, mode:'lines', name:'Train Score', line:{color:'#f59e0b', width:2} },
    { x: ss.stages, y: ss.test,  mode:'lines', name:'Test Score',  line:{color:'#4f46e5', width:2.5} },
  ], {
    ...layout('Staged Score ‚Äî Boosting Progress','Boosting Round','Score'),
    shapes:[{ type:'line', x0:ss.stages[peakI], x1:ss.stages[peakI], y0:0, y1:1,
              line:{dash:'dot',color:'#22c55e',width:2} }],
    annotations:[{ x:ss.stages[peakI], y:ss.test[peakI]+0.01, text:`Peak: ${ss.test[peakI]}`,
                   showarrow:true, arrowhead:2, font:{color:'#22c55e'} }],
  }, {responsive:true,displayModeBar:false});

  Plotly.newPlot('gb-roc', [
    { x: r.roc.fpr, y: r.roc.tpr, mode:'lines', name:`GBM (AUC=${r.metrics.auc})`, line:{color:'#f59e0b',width:2.5} },
    { x:[0,1],y:[0,1],mode:'lines',name:'Random',line:{dash:'dash',color:'#9ca3af'}},
  ], layout('ROC Curve','False Positive Rate','True Positive Rate'), {responsive:true,displayModeBar:false});

  const fi = r.feature_importance;
  const sorted = fi.features.map((f,i)=>[f,fi.values[i]]).sort((a,b)=>b[1]-a[1]);
  Plotly.newPlot('gb-importance', [{
    type:'bar', orientation:'h',
    x: sorted.map(d=>d[1]), y: sorted.map(d=>d[0]),
    marker:{ color: sorted.map((_,i)=>`rgba(245,158,11,${1-i*0.06})`) },
  }], layout('Feature Importance (Gradient-Based)','Importance',''), {responsive:true,displayModeBar:false});

  plotCM('gb-cm', r.confusion_matrix, CURRENT_DATASET);
}

function renderBiz(r) {
  const fi = r.feature_importance;
  const sorted = fi.features.map((f,i)=>[f,fi.values[i]]).sort((a,b)=>b[1]-a[1]).slice(0,7);
  Plotly.newPlot('gb-biz-feat', [{
    type:'bar', x: sorted.map(d=>(d[1]*100).toFixed(2)), y: sorted.map(d=>d[0]),
    orientation:'h', marker:{color:'#f59e0b'},
    text:sorted.map(d=>`${(d[1]*100).toFixed(1)}%`), textposition:'outside',
  }], layout('Key Risk Drivers (Gradient Boosting)','Importance (%)',''), {responsive:true,displayModeBar:false});

  const m = r.metrics;
  const grade = m.auc>=0.83?'üü¢ Excellent':m.auc>=0.72?'üü° Good':'üî¥ Review needed';
  document.getElementById('gb-biz-report').innerHTML = `
    <div class="biz-metric-row"><span>Overall Grade</span><strong>${grade}</strong></div>
    <div class="biz-metric-row"><span>Accuracy</span><strong>${(m.accuracy*100).toFixed(1)}%</strong></div>
    <div class="biz-metric-row"><span>Risk Discrimination</span><strong>${(m.auc*100).toFixed(1)}%</strong></div>
    <div class="biz-metric-row"><span>F1 Score</span><strong>${m.f1}</strong></div>
    <div class="biz-metric-row"><span>Typically best in practice</span><strong>‚úÖ Yes</strong></div>
    <div class="biz-metric-row"><span>Stability</span><strong>‚úÖ High</strong></div>
    <div class="biz-metric-row"><span>Transparency</span><strong>‚ö†Ô∏è Lower (black-box)</strong></div>
  `;
}

runGB();
</script>
{% endblock %}
