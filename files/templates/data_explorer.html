{% extends 'base.html' %}
{% block title %}Data Explorer{% endblock %}
{% block breadcrumb %}<li class="breadcrumb-item active">Data Explorer</li>{% endblock %}

{% block content %}
<div class="page-header">
  <h2 class="page-title"><i class="bi bi-table me-2"></i>Data Explorer</h2>
  <p class="page-subtitle">Explore synthetic banking and insurance datasets — distributions, correlations, and target relationships.</p>
</div>

<!-- Overview KPIs -->
<div class="row g-3 mb-4" id="overview-kpis"></div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" id="explorer-tabs">
  <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-dist">Distributions</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-corr">Correlation</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-cat">Categorical Analysis</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-sample">Sample Data</button></li>
</ul>

<div class="tab-content">

  <!-- Distributions -->
  <div class="tab-pane fade show active" id="tab-dist">
    <div class="row g-3 mb-3">
      <div class="col-auto">
        <label class="form-label fw-semibold">Feature:</label>
        <select class="form-select form-select-sm" id="dist-feature-select" onchange="plotDistribution()"></select>
      </div>
      <div class="col-auto">
        <label class="form-label fw-semibold">Plot type:</label>
        <select class="form-select form-select-sm" id="dist-type" onchange="plotDistribution()">
          <option value="histogram">Histogram</option>
          <option value="box">Box Plot</option>
          <option value="violin">Violin Plot</option>
        </select>
      </div>
    </div>
    <div class="row g-4">
      <div class="col-lg-8"><div class="chart-card"><div id="dist-chart" style="height:380px"></div></div></div>
      <div class="col-lg-4"><div class="chart-card"><div id="target-pie" style="height:380px"></div></div></div>
    </div>
    <div class="row g-4 mt-1">
      <div class="col-12"><div class="chart-card"><div id="feature-overview" style="height:360px"></div></div></div>
    </div>
  </div>

  <!-- Correlation -->
  <div class="tab-pane fade" id="tab-corr">
    <div class="chart-card"><div id="corr-heatmap" style="height:520px"></div></div>
    <div class="insight-box mt-3">
      <i class="bi bi-info-circle-fill me-2 text-primary"></i>
      <strong>Reading the heatmap:</strong> Dark blue = strong positive correlation; dark red = strong negative.
      Features correlated with the target column indicate predictive power. Highly correlated feature pairs may cause multicollinearity in GLM.
    </div>
  </div>

  <!-- Categorical -->
  <div class="tab-pane fade" id="tab-cat">
    <div id="cat-charts" class="row g-4"></div>
  </div>

  <!-- Sample Data -->
  <div class="tab-pane fade" id="tab-sample">
    <div class="card border-0 shadow-sm">
      <div class="card-header d-flex align-items-center justify-content-between">
        <span class="fw-semibold">First 50 Rows (preview)</span>
        <span class="badge bg-secondary" id="sample-badge">—</span>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0 small" id="sample-table">
            <thead id="sample-thead" class="table-dark"></thead>
            <tbody id="sample-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
let distData = null;

function onDatasetChange(ds) { loadAll(ds); }

async function loadAll(ds) {
  ds = ds || CURRENT_DATASET;

  // Overview
  const ov = await apiFetch(`/api/data/overview?dataset=${ds}`);
  const target_label = ds === 'banking' ? 'Default Rate' : 'High-Claim Rate';
  document.getElementById('overview-kpis').innerHTML = `
    ${kpiCard('bi-database-fill','bg-blue','Total Records', ov.n_rows.toLocaleString(), 'synthetic records')}
    ${kpiCard('bi-columns-gap','bg-purple','Features', ov.n_cols - 1, 'predictors')}
    ${kpiCard('bi-exclamation-triangle-fill','bg-orange', target_label, (ov.target_rate*100).toFixed(1)+'%', 'base rate')}
    ${kpiCard('bi-123','bg-teal','Numeric Features', ov.numeric_cols.length - 1, 'continuous vars')}
  `;

  // Distributions
  distData = await apiFetch(`/api/data/distributions?dataset=${ds}`);
  const sel = document.getElementById('dist-feature-select');
  sel.innerHTML = '';
  Object.keys(distData.distributions).forEach(f => {
    sel.innerHTML += `<option value="${f}">${f}</option>`;
  });
  plotDistribution();

  // Target pie
  const total = ov.n_rows;
  const pos = Math.round(ov.target_rate * total);
  const labelMap = ds === 'banking'
    ? ['No Default', 'Default']
    : ['Low Claim', 'High Claim'];
  Plotly.newPlot('target-pie', [{
    type: 'pie', values: [total - pos, pos],
    labels: labelMap,
    marker: { colors: ['#22c55e', '#ef4444'] },
    hole: 0.45,
    textinfo: 'label+percent',
  }], {
    title: { text: 'Target Distribution', font: { size: 14 } },
    showlegend: true, margin: { t:50, l:20, r:20, b:20 },
    paper_bgcolor: 'transparent',
  }, { responsive: true, displayModeBar: false });

  // Feature overview (mean by target)
  plotFeatureOverview(distData, ds);

  // Correlation
  const corr = await apiFetch(`/api/data/correlation?dataset=${ds}`);
  plotHeatmap('corr-heatmap', corr.matrix, corr.cols, 'Correlation Heatmap');

  // Categorical
  const cat = await apiFetch(`/api/data/categorical?dataset=${ds}`);
  const catDiv = document.getElementById('cat-charts');
  catDiv.innerHTML = '';
  Object.entries(cat).forEach(([col, data], i) => {
    const id = `cat-chart-${i}`;
    catDiv.innerHTML += `<div class="col-md-6"><div class="chart-card"><div id="${id}" style="height:300px"></div></div></div>`;
    setTimeout(() => {
      Plotly.newPlot(id, [{
        type: 'bar', x: data.categories, y: data.target_rate.map(v => +(v*100).toFixed(2)),
        marker: { color: data.target_rate.map(v => `rgba(79,70,229,${0.4 + v})`), line: { width: 0 } },
        text: data.count.map(c => `n=${c}`), textposition: 'outside',
        hovertemplate: '<b>%{x}</b><br>Rate: %{y:.1f}%<br>%{text}<extra></extra>',
      }], {
        title: { text: `${col} — Target Rate (%)`, font: { size: 13 } },
        yaxis: { title: 'Target Rate (%)', range: [0, Math.max(...data.target_rate)*120] },
        paper_bgcolor: 'transparent', plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { t: 50, l: 50, r: 20, b: 60 },
      }, { responsive: true, displayModeBar: false });
    }, 0);
  });

  // Sample table
  const sample = await apiFetch(`/api/data/sample?dataset=${ds}`);
  document.getElementById('sample-badge').textContent = `${ov.n_rows.toLocaleString()} total rows, showing 50`;
  const thead = document.getElementById('sample-thead');
  const tbody = document.getElementById('sample-tbody');
  const targetCol = ds === 'banking' ? 'default' : 'high_claim';
  thead.innerHTML = `<tr>${sample.columns.map(c => `<th>${c}</th>`).join('')}</tr>`;
  tbody.innerHTML = sample.records.map(row => {
    const isRisk = row[targetCol] == 1;
    return `<tr class="${isRisk ? 'table-danger' : ''}">${sample.columns.map(c => `<td>${row[c]}</td>`).join('')}</tr>`;
  }).join('');
}

function plotDistribution() {
  if (!distData) return;
  const feat   = document.getElementById('dist-feature-select').value;
  const type   = document.getElementById('dist-type').value;
  const byT    = distData.distributions[feat]?.by_target;
  const colors = { '0': '#22c55e', '1': '#ef4444' };
  const labels = CURRENT_DATASET === 'banking'
    ? { '0': 'No Default', '1': 'Default' }
    : { '0': 'Low Claim', '1': 'High Claim' };
  const traces = Object.entries(byT || {}).map(([t, vals]) => ({
    type: type === 'histogram' ? 'histogram' : type,
    [type === 'box' || type === 'violin' ? 'y' : 'x']: vals,
    name: labels[t] || `Class ${t}`,
    marker: { color: colors[t], opacity: 0.7 },
    opacity: 0.75,
    ...(type === 'violin' ? { box: { visible: true }, meanline: { visible: true } } : {}),
  }));
  Plotly.newPlot('dist-chart', traces, {
    title: `${feat} — by Target Class`,
    barmode: 'overlay',
    paper_bgcolor: 'transparent', plot_bgcolor: 'rgba(0,0,0,0)',
    legend: { orientation: 'h', y: -0.15 },
    margin: { t: 50, l: 60, r: 20, b: 60 },
  }, { responsive: true, displayModeBar: false });
}

function plotFeatureOverview(distData, ds) {
  const feats = Object.keys(distData.distributions);
  const means0 = [], means1 = [], labels0 = [];
  const target0 = ds === 'banking' ? 'No Default' : 'Low Claim';
  const target1 = ds === 'banking' ? 'Default'    : 'High Claim';
  feats.forEach(f => {
    const d = distData.distributions[f].by_target;
    if (d && d['0'] && d['1']) {
      labels0.push(f);
      means0.push(+(d['0'].reduce((a,b)=>a+b,0)/d['0'].length).toFixed(3));
      means1.push(+(d['1'].reduce((a,b)=>a+b,0)/d['1'].length).toFixed(3));
    }
  });
  Plotly.newPlot('feature-overview', [
    { type: 'bar', name: target0, x: labels0, y: means0, marker: { color: '#22c55e' } },
    { type: 'bar', name: target1, x: labels0, y: means1, marker: { color: '#ef4444' } },
  ], {
    title: 'Feature Mean Values by Target Class',
    barmode: 'group',
    paper_bgcolor: 'transparent', plot_bgcolor: 'rgba(0,0,0,0)',
    legend: { orientation: 'h', y: -0.18 },
    margin: { t: 50, l: 60, r: 20, b: 80 },
  }, { responsive: true, displayModeBar: false });
}

loadAll(CURRENT_DATASET);
</script>
{% endblock %}
