{% extends 'base.html' %}
{% block title %}Decision Tree{% endblock %}
{% block breadcrumb %}<li class="breadcrumb-item active">Decision Tree</li>{% endblock %}

{% block content %}
<div class="page-header">
  <div class="d-flex align-items-start justify-content-between flex-wrap gap-2">
    <div>
      <h2 class="page-title"><i class="bi bi-diagram-3-fill me-2"></i>Decision Tree</h2>
      <p class="page-subtitle">A single tree model that makes predictions by asking a sequence of yes/no questions about features.</p>
    </div>
    <div class="view-switch">
      <button class="btn btn-sm btn-primary active" id="btn-ds-view" onclick="switchView('ds')"><i class="bi bi-cpu me-1"></i>Data Scientist</button>
      <button class="btn btn-sm btn-outline-success" id="btn-biz-view" onclick="switchView('biz')"><i class="bi bi-people me-1"></i>Stakeholder</button>
    </div>
  </div>
</div>

<div class="control-panel mb-4">
  <div class="row g-3 align-items-end">
    <div class="col-sm-3 col-lg-2">
      <label class="form-label">Max Depth</label>
      <input type="range" class="form-range" id="dt-depth" min="1" max="12" value="4" oninput="document.getElementById('dt-depth-val').textContent=this.value">
      <div class="d-flex justify-content-between"><small>1</small><small id="dt-depth-val" class="fw-bold">4</small><small>12</small></div>
    </div>
    <div class="col-sm-3 col-lg-2">
      <label class="form-label">Min Samples Split</label>
      <select class="form-select form-select-sm" id="dt-mss">
        <option value="5">5</option><option value="10">10</option>
        <option value="20" selected>20</option><option value="50">50</option><option value="100">100</option>
      </select>
    </div>
    <div class="col-sm-3 col-lg-2">
      <label class="form-label">Criterion</label>
      <select class="form-select form-select-sm" id="dt-crit">
        <option value="gini" selected>Gini Impurity</option>
        <option value="entropy">Entropy (Info Gain)</option>
        <option value="log_loss">Log Loss</option>
      </select>
    </div>
    <div class="col-sm-3 col-lg-2">
      <label class="form-label">Test Split</label>
      <select class="form-select form-select-sm" id="dt-split">
        <option value="0.15">15%</option><option value="0.20" selected>20%</option><option value="0.30">30%</option>
      </select>
    </div>
    <div class="col-auto">
      <button class="btn btn-primary" onclick="runDT()"><i class="bi bi-play-fill me-1"></i>Train Tree</button>
    </div>
    <div class="col-auto" id="dt-spinner" style="display:none">
      <div class="spinner-border spinner-border-sm text-primary"></div>
    </div>
  </div>
</div>

<div class="row g-3 mb-4" id="dt-metrics"></div>

<div id="view-ds">
  <div class="row g-4">
    <div class="col-lg-6"><div class="chart-card"><div id="dt-depth-curve" style="height:380px"></div></div></div>
    <div class="col-lg-6"><div class="chart-card"><div id="dt-roc" style="height:380px"></div></div></div>
    <div class="col-lg-6"><div class="chart-card"><div id="dt-importance" style="height:360px"></div></div></div>
    <div class="col-lg-6"><div class="chart-card"><div id="dt-cm" style="height:360px"></div></div></div>
  </div>

  <!-- Tree rules -->
  <div class="chart-card mt-4">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h6 class="fw-bold mb-0">ðŸŒ³ Extracted Decision Rules (first 4 levels)</h6>
      <span class="badge bg-secondary" id="dt-stats-badge">â€”</span>
    </div>
    <pre id="dt-rules" class="tree-rules"></pre>
  </div>

  <div class="insight-box mt-3">
    <i class="bi bi-lightbulb-fill me-2 text-warning"></i>
    <strong>Bias-Variance tradeoff:</strong> A very deep tree memorises training data (high variance = overfitting).
    The depth-complexity curve shows where test accuracy peaks â€” choose that depth.
    Gini and Entropy produce nearly identical splits in practice; Entropy is slightly more computationally expensive.
  </div>
</div>

<div id="view-biz" style="display:none">
  <div class="stakeholder-banner mb-4">
    <i class="bi bi-info-circle-fill me-2"></i>
    <strong>What is a Decision Tree?</strong>
    Imagine a flowchart of yes/no questions â€” "Is the credit score below 620? â†’ Yes â†’ Is debt-to-income above 40%? â†’ Yes â†’ High Risk."
    It is completely transparent: you can read every rule the model uses.
  </div>
  <div class="row g-4">
    <div class="col-lg-6"><div class="chart-card"><div id="dt-biz-feat" style="height:360px"></div></div></div>
    <div class="col-lg-6">
      <div class="chart-card">
        <h6 class="fw-bold mb-3">ðŸ“‹ Model Report Card</h6>
        <div id="dt-biz-report"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let dtResult = null;
function onDatasetChange() { runDT(); }
function switchView(v) {
  document.getElementById('view-ds').style.display  = v==='ds'  ? '' : 'none';
  document.getElementById('view-biz').style.display = v==='biz' ? '' : 'none';
  document.getElementById('btn-ds-view').className  = 'btn btn-sm ' + (v==='ds'  ? 'btn-primary active' : 'btn-outline-primary');
  document.getElementById('btn-biz-view').className = 'btn btn-sm ' + (v==='biz' ? 'btn-success active' : 'btn-outline-success');
  if (v === 'biz' && dtResult) renderBiz(dtResult);
}

async function runDT() {
  show('dt-spinner');
  dtResult = await apiPost('/api/model/decision-tree', {
    dataset: CURRENT_DATASET,
    max_depth: parseInt(document.getElementById('dt-depth').value),
    min_samples_split: parseInt(document.getElementById('dt-mss').value),
    criterion: document.getElementById('dt-crit').value,
    test_size: parseFloat(document.getElementById('dt-split').value),
  });
  hide('dt-spinner');
  renderMetrics('dt-metrics', dtResult.metrics, dtResult.train_size, dtResult.test_size);
  renderDTCharts(dtResult);
}

function renderDTCharts(r) {
  // Depth curve
  const dc = r.depth_curve;
  Plotly.newPlot('dt-depth-curve', [
    { x: dc.depths, y: dc.train, mode: 'lines+markers', name: 'Train', line: { color: '#4f46e5' } },
    { x: dc.depths, y: dc.test,  mode: 'lines+markers', name: 'Test',  line: { color: '#22c55e' } },
  ], {
    ...layout('Depth vs Accuracy (Bias-Variance Tradeoff)', 'Max Depth', 'Accuracy'),
    shapes: [{ type:'line', x0: parseInt(document.getElementById('dt-depth').value),
               x1: parseInt(document.getElementById('dt-depth').value),
               y0:0, y1:1, line:{ dash:'dot', color:'#f97316', width:2 }}],
    annotations:[{ x: parseInt(document.getElementById('dt-depth').value), y:0.5,
                   text:'current', showarrow:false, font:{color:'#f97316',size:11}, xshift:20 }],
  }, { responsive:true, displayModeBar:false });

  // ROC
  Plotly.newPlot('dt-roc', [
    { x: r.roc.fpr, y: r.roc.tpr, mode:'lines', name:`Tree (AUC=${r.metrics.auc})`, line:{color:'#f97316',width:2.5} },
    { x:[0,1], y:[0,1], mode:'lines', name:'Random', line:{dash:'dash',color:'#9ca3af'} },
  ], layout('ROC Curve','False Positive Rate','True Positive Rate'), {responsive:true,displayModeBar:false});

  // Feature importance
  const fi = r.feature_importance;
  const sorted = fi.features.map((f,i)=>[f,fi.values[i]]).sort((a,b)=>b[1]-a[1]);
  Plotly.newPlot('dt-importance', [{
    type:'bar', orientation:'h',
    x: sorted.map(d=>d[1]), y: sorted.map(d=>d[0]),
    marker:{ color: sorted.map((_,i)=>`rgba(249,115,22,${1-i*0.07})`) },
  }], layout('Feature Importance (Gini Decrease)','Importance',''), {responsive:true,displayModeBar:false});

  // CM
  plotCM('dt-cm', r.confusion_matrix, CURRENT_DATASET);

  // Rules
  document.getElementById('dt-rules').textContent = r.tree_rules;
  document.getElementById('dt-stats-badge').textContent =
    `Depth: ${r.actual_depth} Â· Leaves: ${r.n_leaves} Â· CV AUC: ${r.cv_auc.mean} Â±${r.cv_auc.std}`;
}

function renderBiz(r) {
  const fi = r.feature_importance;
  const sorted = fi.features.map((f,i)=>[f,fi.values[i]]).sort((a,b)=>b[1]-a[1]).slice(0,7);
  Plotly.newPlot('dt-biz-feat', [{
    type:'bar', x: sorted.map(d=>(d[1]*100).toFixed(1)), y: sorted.map(d=>d[0]),
    orientation:'h', marker:{color:'#f97316'},
    text: sorted.map(d=>`${(d[1]*100).toFixed(1)}%`), textposition:'outside',
  }], layout('What Drives the Model Decision? (Feature Influence %)','Importance (%)',''), {responsive:true,displayModeBar:false});

  const m = r.metrics;
  const grade = m.auc>=0.80?'ðŸŸ¢ Excellent':m.auc>=0.70?'ðŸŸ¡ Good':'ðŸ”´ Review needed';
  document.getElementById('dt-biz-report').innerHTML = `
    <div class="biz-metric-row"><span>Overall Grade</span><strong>${grade}</strong></div>
    <div class="biz-metric-row"><span>Accuracy</span><strong>${(m.accuracy*100).toFixed(1)}%</strong></div>
    <div class="biz-metric-row"><span>Risk Discrimination</span><strong>${(m.auc*100).toFixed(1)}%</strong></div>
    <div class="biz-metric-row"><span>Rules extracted</span><strong>${r.n_leaves} decision paths</strong></div>
    <div class="biz-metric-row"><span>5-fold CV AUC</span><strong>${r.cv_auc.mean} Â± ${r.cv_auc.std}</strong></div>
    <div class="biz-metric-row"><span>Transparency</span><strong>âœ… Fully readable rules</strong></div>
    <div class="biz-metric-row"><span>Regulatory fit</span><strong>âœ… High (auditable)</strong></div>
  `;
}

runDT();
</script>
{% endblock %}
