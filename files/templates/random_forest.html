{% extends 'base.html' %}
{% block title %}Random Forest â€” Bagging{% endblock %}
{% block breadcrumb %}<li class="breadcrumb-item active">Random Forest</li>{% endblock %}

{% block content %}
<div class="page-header">
  <div class="d-flex align-items-start justify-content-between flex-wrap gap-2">
    <div>
      <h2 class="page-title"><i class="bi bi-tree-fill me-2"></i>Random Forest <span class="badge bg-green fs-6 ms-1">Bagging</span></h2>
      <p class="page-subtitle">An ensemble of decorrelated decision trees â€” each tree votes; the majority wins. Reduces variance vs a single tree.</p>
    </div>
    <div class="view-switch">
      <button class="btn btn-sm btn-primary active" id="btn-ds-view" onclick="switchView('ds')"><i class="bi bi-cpu me-1"></i>Data Scientist</button>
      <button class="btn btn-sm btn-outline-success" id="btn-biz-view" onclick="switchView('biz')"><i class="bi bi-people me-1"></i>Stakeholder</button>
    </div>
  </div>
</div>

<div class="control-panel mb-4">
  <div class="row g-3 align-items-end">
    <div class="col-sm-4 col-lg-2">
      <label class="form-label">N Estimators</label>
      <input type="range" class="form-range" id="rf-n" min="10" max="300" step="10" value="100"
             oninput="document.getElementById('rf-n-val').textContent=this.value">
      <div class="d-flex justify-content-between"><small>10</small><small id="rf-n-val" class="fw-bold">100</small><small>300</small></div>
    </div>
    <div class="col-sm-4 col-lg-2">
      <label class="form-label">Max Depth</label>
      <select class="form-select form-select-sm" id="rf-depth">
        <option value="">None (full)</option>
        <option value="3">3</option><option value="5">5</option>
        <option value="7">7</option><option value="10">10</option>
      </select>
    </div>
    <div class="col-sm-4 col-lg-2">
      <label class="form-label">Max Features</label>
      <select class="form-select form-select-sm" id="rf-feat">
        <option value="sqrt" selected>sqrt (default)</option>
        <option value="log2">log2</option>
        <option value="0.5">50% of features</option>
      </select>
    </div>
    <div class="col-sm-4 col-lg-2">
      <label class="form-label">Test Split</label>
      <select class="form-select form-select-sm" id="rf-split">
        <option value="0.15">15%</option><option value="0.20" selected>20%</option><option value="0.30">30%</option>
      </select>
    </div>
    <div class="col-auto">
      <button class="btn btn-success" onclick="runRF()"><i class="bi bi-play-fill me-1"></i>Train Forest</button>
    </div>
    <div class="col-auto" id="rf-spinner" style="display:none">
      <div class="spinner-border spinner-border-sm text-success"></div>
    </div>
  </div>
</div>

<div class="row g-3 mb-4" id="rf-metrics"></div>

<div id="view-ds">
  <div class="row g-4">
    <div class="col-lg-6"><div class="chart-card"><div id="rf-lc" style="height:380px"></div></div></div>
    <div class="col-lg-6"><div class="chart-card"><div id="rf-roc" style="height:380px"></div></div></div>
    <div class="col-lg-6"><div class="chart-card"><div id="rf-importance" style="height:380px"></div></div></div>
    <div class="col-lg-6"><div class="chart-card"><div id="rf-cm" style="height:380px"></div></div></div>
    <div class="col-12"><div class="chart-card"><div id="rf-vs-tree" style="height:300px"></div></div></div>
  </div>
  <div class="insight-box mt-3">
    <i class="bi bi-lightbulb-fill me-2 text-warning"></i>
    <strong>Bagging explained:</strong> Bootstrap Aggregation â€” each tree is trained on a random sample of rows
    (with replacement) and a random subset of features. This decorrelates trees, reducing ensemble variance.
    <strong>OOB score</strong> uses the ~37% of rows not sampled for each tree as a built-in validation set â€” no separate hold-out needed.
  </div>
</div>

<div id="view-biz" style="display:none">
  <div class="stakeholder-banner mb-4">
    <i class="bi bi-info-circle-fill me-2"></i>
    <strong>What is Random Forest?</strong>
    Instead of asking one expert (decision tree), we ask hundreds of independent experts and take a vote.
    This "wisdom of crowds" approach is more reliable than any single tree â€” like averaging many analysts' views.
  </div>
  <div class="row g-4">
    <div class="col-lg-8"><div class="chart-card"><div id="rf-biz-feat" style="height:380px"></div></div></div>
    <div class="col-lg-4">
      <div class="chart-card">
        <h6 class="fw-bold mb-3">ğŸ“‹ Model Report Card</h6>
        <div id="rf-biz-report"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let rfResult = null;
function onDatasetChange() { runRF(); }
function switchView(v) {
  document.getElementById('view-ds').style.display  = v==='ds'  ? '' : 'none';
  document.getElementById('view-biz').style.display = v==='biz' ? '' : 'none';
  document.getElementById('btn-ds-view').className  = 'btn btn-sm ' + (v==='ds'  ? 'btn-primary active' : 'btn-outline-primary');
  document.getElementById('btn-biz-view').className = 'btn btn-sm ' + (v==='biz' ? 'btn-success active' : 'btn-outline-success');
  if (v==='biz' && rfResult) renderBiz(rfResult);
}

async function runRF() {
  show('rf-spinner');
  const maxD = document.getElementById('rf-depth').value;
  rfResult = await apiPost('/api/model/random-forest', {
    dataset: CURRENT_DATASET,
    n_estimators: parseInt(document.getElementById('rf-n').value),
    max_depth: maxD === '' ? null : parseInt(maxD),
    max_features: document.getElementById('rf-feat').value,
    test_size: parseFloat(document.getElementById('rf-split').value),
  });
  hide('rf-spinner');
  renderMetrics('rf-metrics', rfResult.metrics, rfResult.train_size, rfResult.test_size);
  renderRFCharts(rfResult);
}

function renderRFCharts(r) {
  const lc = r.learning_curve;
  Plotly.newPlot('rf-lc', [
    { x: lc.n_estimators, y: lc.oob,  mode:'lines+markers', name:'OOB Score',  line:{color:'#16a34a'} },
    { x: lc.n_estimators, y: lc.test, mode:'lines+markers', name:'Test Score', line:{color:'#4f46e5'} },
  ], layout('Learning Curve (n_estimators)','Number of Trees','Score'), {responsive:true,displayModeBar:false});

  Plotly.newPlot('rf-roc', [
    { x: r.roc.fpr, y: r.roc.tpr, mode:'lines', name:`RF (AUC=${r.metrics.auc})`, line:{color:'#16a34a',width:2.5} },
    { x:[0,1],y:[0,1],mode:'lines',name:'Random',line:{dash:'dash',color:'#9ca3af'}},
  ], layout('ROC Curve','False Positive Rate','True Positive Rate'), {responsive:true,displayModeBar:false});

  const fi = r.feature_importance;
  const sorted = fi.features.map((f,i)=>[f,fi.values[i]]).sort((a,b)=>b[1]-a[1]);
  Plotly.newPlot('rf-importance', [{
    type:'bar', orientation:'h',
    x: sorted.map(d=>d[1]), y: sorted.map(d=>d[0]),
    marker:{ color: sorted.map((_,i)=>`rgba(22,163,74,${1-i*0.06})`) },
  }], layout('Feature Importance (Mean Decrease Impurity)','Importance',''), {responsive:true,displayModeBar:false});

  plotCM('rf-cm', r.confusion_matrix, CURRENT_DATASET);

  // RF vs Single Tree comparison
  Plotly.newPlot('rf-vs-tree', [{
    type:'bar', name:'Accuracy', x:['Single Tree','Random Forest'],
    y:[r.single_tree_acc, r.metrics.accuracy], marker:{color:['#f97316','#16a34a']},
    text:[`${(r.single_tree_acc*100).toFixed(2)}%`,`${(r.metrics.accuracy*100).toFixed(2)}%`], textposition:'outside',
  },{
    type:'bar', name:'AUC', x:['Single Tree','Random Forest'],
    y:[r.single_tree_auc, r.metrics.auc], marker:{color:['#fb923c','#4ade80']},
    text:[`${(r.single_tree_auc*100).toFixed(2)}%`,`${(r.metrics.auc*100).toFixed(2)}%`], textposition:'outside',
  }], {
    ...layout('Bagging Benefit: Random Forest vs Single Decision Tree','','Score'),
    barmode:'group',
  }, {responsive:true,displayModeBar:false});
}

function renderBiz(r) {
  const fi = r.feature_importance;
  const sorted = fi.features.map((f,i)=>[f,fi.values[i]]).sort((a,b)=>b[1]-a[1]).slice(0,7);
  Plotly.newPlot('rf-biz-feat', [{
    type:'bar', x:sorted.map(d=>(d[1]*100).toFixed(2)), y:sorted.map(d=>d[0]),
    orientation:'h', marker:{color:'#16a34a'},
    text:sorted.map(d=>`${(d[1]*100).toFixed(1)}%`), textposition:'outside',
  }], layout('Key Risk Drivers (% contribution to model decision)','Importance (%)',''), {responsive:true,displayModeBar:false});

  const m = r.metrics;
  const grade = m.auc>=0.82?'ğŸŸ¢ Excellent':m.auc>=0.72?'ğŸŸ¡ Good':'ğŸ”´ Review needed';
  document.getElementById('rf-biz-report').innerHTML = `
    <div class="biz-metric-row"><span>Overall Grade</span><strong>${grade}</strong></div>
    <div class="biz-metric-row"><span>Accuracy</span><strong>${(m.accuracy*100).toFixed(1)}%</strong></div>
    <div class="biz-metric-row"><span>Risk Discrimination</span><strong>${(m.auc*100).toFixed(1)}%</strong></div>
    <div class="biz-metric-row"><span>OOB Validation Score</span><strong>${(r.oob_score*100).toFixed(2)}%</strong></div>
    <div class="biz-metric-row"><span>Improvement vs single tree (AUC)</span><strong>+${((m.auc - r.single_tree_auc)*100).toFixed(2)}%</strong></div>
    <div class="biz-metric-row"><span>Stability</span><strong>âœ… High (averaged predictions)</strong></div>
    <div class="biz-metric-row"><span>Transparency</span><strong>âš ï¸ Medium (feature importance available)</strong></div>
  `;
}

runRF();
</script>
{% endblock %}
